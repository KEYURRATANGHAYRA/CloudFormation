{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Test",
  "Parameters": {
    "s3BucketWithFunctions": {
      "Description": "Name of S3 bucket where the Lambda functions are hosted in",
      "Type": "String",
      "Default": "lambda-studies"
    },
    "LambdaFunctionPackage": {
      "Description": "Name of zip file that contains the Lambda function",
      "Type": "String",
      "Default": "TestFunction.zip"
    },
    "LambdaPermissionsPackage": {
      "Description": "Name of zip file that contains the extra lambda function that sets permissions to the SNS topic automatically",
      "Type": "String",
      "Default": "SetsPermissionsForSNSTopic.zip"
    },
    "AMI": {
      "Description": "AMI ID that is going to be used by the ASG",
      "Type": "String",
      "Default": "ami-e4d18e93",
      "MinLength": "10",
      "MaxLength": "15"
    },
    "KeyName": {
      "Description": "Name of Key Pair that is going to be used by the instances launched in ASG",
      "Type": "String",
      "Default": "LinuxKey"
    },
    "InstanceType": {
      "Description": "Instance Type that is going to be set-up for the instances in ASG",
      "Type": "String",
      "Default": "t2.micro"
    }
  },
  "Resources": {
    "CustomLC": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "ImageId": {
          "Ref": "AMI"
        },
        "KeyName": {
          "Ref": "KeyName"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        }
      }
    },
    "CustomASG" : {
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : {
        "AvailabilityZones" : { "Fn::GetAZs" : "" },
        "LaunchConfigurationName" : { "Ref" : "CustomLC" },
        "MinSize" : "2",
        "MaxSize" : "5",
        "DesiredCapacity" : "3",
        "NotificationConfigurations" : 
        [ 
          {
            "TopicARN" : { "Ref" : "CustomSNSTopic" },
            "NotificationTypes" : [
              "autoscaling:EC2_INSTANCE_LAUNCH",
              "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
              "autoscaling:EC2_INSTANCE_TERMINATE",
              "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
            ]
          }
        ]
      }
    },
    "CustomSNSTopic" : {
    "Type" : "AWS::SNS::Topic",
    "Properties" : {
        "Subscription" : [ {
            "Endpoint" : "eduardoamendola@gmail.com",
            "Protocol" : "email"
        } ]
      }
    }
  },
  "Outputs": {
    "AutoScalingGroup" : {
      "Value" : { "Ref": "CustomASG" }
    },
    "LaunchConfiguration" : { 
      "Value" : { "Ref": "CustomLC" }
    },
    "SNSTopic" : { 
      "Value" : { "Ref": "CustomSNSTopic" }
    }
  }
}
